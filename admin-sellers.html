<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MatrixMarket - Admin Seller Payments</title>
<style>
  /* --- Body & Gradient --- */
  body {
    font-family:"Poppins",sans-serif;
    background:linear-gradient(135deg,#0f172a,#1e293b,#4f46e5,#06b6d4);
    background-size:400% 400%;
    animation:bgMove 15s ease infinite;
    color:white;
    margin:0; padding:0;
  }
  @keyframes bgMove{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}

  /* --- Header --- */
  header {
    background: rgba(0,0,0,0.4);
    padding: 15px 30px;
    display:flex; justify-content:space-between; align-items:center;
    backdrop-filter: blur(10px);
  }
  header .logo { font-size:1.6rem; color:#06b6d4; font-weight:bold; text-shadow:0 0 10px #06b6d4; }
  nav a { color:white; text-decoration:none; margin-left:15px; font-weight:500; transition:.3s; }
  nav a:hover { color:#06b6d4; }

  /* --- Container --- */
  .container {
    max-width: 1200px; margin:40px auto;
    background: rgba(255,255,255,0.08); padding:30px; border-radius:20px;
    box-shadow:0 0 20px rgba(6,182,212,0.5); overflow-x:auto;
  }

  h1 { text-align:center; margin-bottom:20px; text-shadow:0 0 12px #06b6d4; }

  /* --- Search & CSV --- */
  .controls { display:flex; justify-content:space-between; flex-wrap:wrap; margin-bottom:15px; }
  .controls input[type="text"] { flex:1; min-width:250px; padding:10px; border:none; border-radius:10px; background: rgba(255,255,255,0.1); color:white; margin-bottom:10px;}
  .controls button { background:#06b6d4; color:white; border:none; padding:10px 15px; border-radius:10px; cursor:pointer; margin-left:10px; transition:.2s; }
  .controls button:hover { background:#0891b2; }

  /* --- Table --- */
  table { width:100%; border-collapse:collapse; min-width:900px; }
  th,td { border:1px solid rgba(255,255,255,0.2); padding:10px; text-align:center; vertical-align:middle; font-size:.95rem; }
  th { background: rgba(6,182,212,0.3); position:sticky; top:0; z-index:1; }
  tr:hover { background: rgba(255,255,255,0.05); }

  /* --- Buttons --- */
  .btn { padding:6px 12px; border:none; border-radius:8px; cursor:pointer; color:white; margin:2px; font-weight:500; transition:0.2s ease-in-out; }
  .approve { background:#06b6d4; } .approve:hover { background:#0891b2; transform:translateY(-1px);}
  .decline { background:#ef4444; } .decline:hover { background:#b91c1c; transform:translateY(-1px);}
  .bulk { background:#8b5cf6; } .bulk:hover { background:#7c3aed; }

  /* --- Status --- */
  .status-badge { padding:5px 10px; border-radius:8px; font-weight:bold; white-space:nowrap; }
  .status-pending { background: rgba(245,158,11,0.2); color:#f59e0b; }
  .status-approved { background: rgba(34,197,94,0.2); color:#22c55e; }
  .status-declined { background: rgba(239,68,68,0.2); color:#ef4444; }
  .status-proof-submitted { background: rgba(59,130,246,0.2); color:#3b82f6; }
  .status-confirmed-by-seller { background: rgba(139,92,246,0.2); color:#8b5cf6; }

  /* --- Footer --- */
  footer { text-align:center; padding:15px; background: rgba(255,255,255,0.08); border-top:1px solid rgba(255,255,255,0.1); margin-top:40px; }

  .proof-link { color:#06b6d4; text-decoration:underline; cursor:pointer; }
</style>
</head>

<body>
<header>
  <div class="logo">MatrixMarket Admin</div>
  <nav>
    <a href="dashboard-admin.html">Dashboard</a>
    <a href="admin-sellers.html">Sellers</a>
    <a href="admin-users.html">Users</a>
    <a href="admin-edit-user-seller.html">Edit</a>
    <a href="admin-payments.html" style="font-weight:bold;color:#06b6d4;">Seller Payments</a>
  </nav>
</header>

<div class="container">
  <h1>ðŸ’¸ Manage Seller Subscription Requests</h1>

  <div class="controls">
    <input type="text" id="searchBox" placeholder="Search by seller email, store, or plan..." onkeyup="handleSearch()">
    <div>
      <button onclick="approveSelected()" class="bulk">Approve Selected</button>
      <button onclick="declineSelected()" class="bulk">Decline Selected</button>
      <button onclick="exportCSV()">Download CSV</button>
    </div>
  </div>

  <table id="paymentRequestTable"></table>
</div>

<footer>Â© 2025 MatrixMarket | Admin Seller Payment Control</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyDFrctk2MZajP7OmECXe5npHAV0dODH9jk",
  authDomain:"matrixmarketplace-1bd71.firebaseapp.com",
  databaseURL:"https://matrixmarketplace-1bd71-default-rtdb.firebaseio.com",
  projectId:"matrixmarketplace-1bd71",
  storageBucket:"matrixmarketplace-1bd71.firebasestorage.app",
  messagingSenderId:"10374416997",
  appId:"1:10374416997:web:9626c569e845c14a87548c",
  measurementId:"G-DTC2GM9L92"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let sellerPaymentRequests = {};
let selectedRequests = new Set();

// --- Render Table ---
function renderTable() {
  const table = document.getElementById("paymentRequestTable");
  const search = document.getElementById("searchBox").value.toLowerCase();

  table.innerHTML = `<tr>
    <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"/></th>
    <th>Email</th><th>Store</th><th>Plan</th><th>Amount</th><th>Status</th><th>Submitted On</th><th>Proof</th><th>Action</th>
  </tr>`;

  const filtered = Object.values(sellerPaymentRequests).filter(req => 
    req.email?.toLowerCase().includes(search) ||
    req.storeName?.toLowerCase().includes(search) ||
    req.plan?.toLowerCase().includes(search) ||
    req.status?.toLowerCase().includes(search)
  );

  if(!filtered.length){
    table.innerHTML += `<tr><td colspan="9">No seller payment requests found.</td></tr>`;
    return;
  }

  filtered.forEach(req => {
    let statusClass = "status-pending";
    switch(req.status){
      case "Approved": statusClass="status-approved"; break;
      case "Declined": statusClass="status-declined"; break;
      case "Proof Submitted": statusClass="status-proof-submitted"; break;
      case "Payment Confirmed by Seller": statusClass="status-confirmed-by-seller"; break;
    }

    const proofLink = req.receiptURL ? `<a href="${req.receiptURL}" target="_blank" class="proof-link">View</a>` : "N/A";
    const amount = parseFloat(req.amount).toFixed(2);
    const date = req.submittedAt ? new Date(req.submittedAt).toLocaleString() : "N/A";

    table.innerHTML += `<tr>
      <td><input type="checkbox" class="rowCheckbox" data-id="${req.id}" onchange="toggleSelect('${req.id}', this)"/></td>
      <td>${req.email}</td>
      <td>${req.storeName || 'N/A'}</td>
      <td>${req.plan || 'N/A'}</td>
      <td>${amount} GMD</td>
      <td><span class="status-badge ${statusClass}">${req.status}</span></td>
      <td>${date}</td>
      <td>${proofLink}</td>
      <td>
        <button class="btn approve" onclick="updateRequest('${req.id}','Approved','${req.userId}')">Approve</button>
        <button class="btn decline" onclick="updateRequest('${req.id}','Declined','${req.userId}')">Decline</button>
      </td>
    </tr>`;
  });
}

// --- Toggle Select ---
function toggleSelect(id, checkbox){
  if(checkbox.checked) selectedRequests.add(id);
  else selectedRequests.delete(id);
}
function toggleSelectAll(master){
  const checkboxes = document.querySelectorAll(".rowCheckbox");
  checkboxes.forEach(cb => { cb.checked = master.checked; toggleSelect(cb.dataset.id, cb); });
}

// --- Bulk Actions ---
async function approveSelected(){ for(const id of selectedRequests){ await updateRequest(id,'Approved'); } selectedRequests.clear(); }
async function declineSelected(){ for(const id of selectedRequests){ await updateRequest(id,'Declined'); } selectedRequests.clear(); }

// --- Update Request ---
async function updateRequest(id, action, userId){
  if(!confirm(`Are you sure you want to ${action} this request?`)) return;
  try{
    await update(ref(db,'pendingSellerPayments/'+id), { status:action, adminActionDate:new Date().toLocaleString() });
    if(userId && action==='Approved'){
      await update(ref(db,'sellers/'+userId), { status:'Approved', subscription:'Active' });
    } else if(userId && action==='Declined'){
      await update(ref(db,'sellers/'+userId), { status:'Declined', subscription:'Inactive' });
    }
    alert(`${action} successful!`);
  } catch(e){ console.error(e); alert("Error updating request."); }
}

// --- Export CSV ---
function exportCSV(){
  let csv = "Email,Store,Plan,Amount,Status,Submitted On\n";
  Object.values(sellerPaymentRequests).forEach(r => {
    const date = r.submittedAt ? new Date(r.submittedAt).toLocaleString() : "N/A";
    csv += `${r.email},${r.storeName || ''},${r.plan || ''},${r.amount},${r.status},${date}\n`;
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download='seller_payments.csv'; a.click(); URL.revokeObjectURL(url);
}

// --- Debounced Search ---
let searchTimeout;
function handleSearch(){
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(renderTable,300);
}

// --- Firebase Listener ---
onAuthStateChanged(auth,user=>{
  if(!user){ alert("Login required."); window.location.href="admin-login.html"; return; }
  const sellerPaymentsRef = ref(db,'pendingSellerPayments');
  onValue(sellerPaymentsRef,snapshot=>{
    sellerPaymentRequests={};
    const data = snapshot.val() || {};
    Object.keys(data).forEach(k=>sellerPaymentRequests[k]={ id:k,...data[k] });
    renderTable();
  });
});
</script>
</body>
</html>

