<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin Analytics | Matrix Marketplace</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: "Poppins", sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f172a, #1e293b, #4f46e5, #06b6d4);
            background-size: 400% 400%;
            animation: bgMove 12s ease infinite;
            color: #fff;
            display: flex;
            flex-direction: column;
        }

        @keyframes bgMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        header {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
            border-radius: 10px;
        }

        header .logo {
            font-size: 1.6rem;
            color: #06b6d4;
            font-weight: bold;
            text-shadow: 0 0 10px #06b6d4;
        }

        nav { display: flex; align-items: center; }
        nav a {
            color: white;
            text-decoration: none;
            margin-left: 15px;
            font-weight: 500;
            transition: 0.3s;
        }
        nav a:hover { color: #06b6d4; }
        .logout-btn {
            background-color: #ef4444;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 20px;
            transition: background-color 0.3s ease;
        }
        .logout-btn:hover { background-color: #dc2626; }

        h1 {
            text-align: center;
            color: #06b6d4;
            margin-bottom: 25px;
            text-shadow: 0 0 10px #06b6d4, 0 0 20px #4f46e5;
        }

        .stats-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-box {
            background: rgba(30, 41, 59, 0.9);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            min-width: 180px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
        }

        .stat-box h2 { margin: 5px 0; color: #06b6d4; }

        .chart-section {
            background: rgba(30, 41, 59, 0.85);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
            flex-grow: 1;
        }

        canvas { max-height: 400px; }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div id="loadingOverlay" class="loading-overlay">Checking admin access...</div>

    <header>
        <div class="logo">MatrixMarket Admin</div>
        <nav>
            <a href="dashboard-admin.html">Dashboard</a>
            <a href="admin-sellers.html">Sellers</a>
            <a href="admin-users.html">Users</a>
            <a href="admin-payments.html">Payments</a>
            <a href="admin-code.html">Codes</a>
            <a href="admin-edit-user-seller.html">Edit</a>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </nav>
    </header>

    <h1>ðŸ“Š Matrix Admin Live Analytics</h1>

    <div class="stats-container">
        <div class="stat-box">
            <h2 id="totalUsers">0</h2>
            <p>Total Users</p>
        </div>
        <div class="stat-box">
            <h2 id="totalSellers">0</h2>
            <p>Total Sellers</p>
        </div>
        <div class="stat-box">
            <h2 id="totalDeposits">0</h2>
            <p>Total Deposits (GMD)</p>
        </div>
        <div class="stat-box">
            <h2 id="totalWithdrawals">0</h2>
            <p>Total Withdrawals (GMD)</p>
        </div>
    </div>

    <div class="chart-section">
        <canvas id="userGrowthChart"></canvas>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFrctk2MZajP7OmECXe5npHAV0dODH9jk",
            authDomain: "matrixmarketplace-1bd71.firebaseapp.com",
            databaseURL: "https://matrixmarketplace-1bd71-default-rtdb.firebaseio.com",
            projectId: "matrixmarketplace-1bd71",
            storageBucket: "matrixmarketplace-1bd71.firebasestorage.app",
            messagingSenderId: "10374416997",
            appId: "1:10374416997:web:068ef937272b3de687548c",
            measurementId: "G-EH1NNVS55W"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        const totalUsersEl = document.getElementById('totalUsers');
        const totalSellersEl = document.getElementById('totalSellers');
        const totalDepositsEl = document.getElementById('totalDeposits');
        const totalWithdrawalsEl = document.getElementById('totalWithdrawals');
        const loadingOverlay = document.getElementById('loadingOverlay');

        let userGrowthChart;

        function initializeChart() {
            const ctx = document.getElementById('userGrowthChart').getContext('2d');
            userGrowthChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [
                    { label: 'New Users', backgroundColor: '#06b6d4', data: [] },
                    { label: 'New Sellers', backgroundColor: '#4f46e5', data: [] }
                ]},
                options: {
                    responsive:true, maintainAspectRatio:false,
                    scales:{ y:{beginAtZero:true,ticks:{color:'#fff'},grid:{color:'rgba(255,255,255,0.1)'}},
                             x:{ticks:{color:'#fff'},grid:{color:'rgba(255,255,255,0.1)'}}},
                    plugins:{ legend:{labels:{color:'#fff'}} }
                }
            });
        }

        function fetchDataAndRenderAnalytics() {
            onValue(ref(db,'users'), snapshot=>{
                const users = snapshot.val()||{};
                const totalUsers = Object.keys(users).length;
                const sellers = Object.values(users).filter(u=>u.accountType==='seller');
                const totalSellers = sellers.length;

                totalUsersEl.innerText = totalUsers;
                totalSellersEl.innerText = totalSellers;

                const userGrowth = {};
                Object.values(users).forEach(u=>{
                    const dateKey = u.createdAt ? new Date(u.createdAt).toISOString().split('T')[0] : 'Unknown';
                    if(!userGrowth[dateKey]) userGrowth[dateKey] = {newUsers:0,newSellers:0};
                    userGrowth[dateKey].newUsers++;
                    if(u.accountType==='seller') userGrowth[dateKey].newSellers++;
                });

                const sortedDates = Object.keys(userGrowth).sort();
                userGrowthChart.data.labels = sortedDates;
                userGrowthChart.data.datasets[0].data = sortedDates.map(d=>userGrowth[d].newUsers);
                userGrowthChart.data.datasets[1].data = sortedDates.map(d=>userGrowth[d].newSellers);
                userGrowthChart.update();
            });

            onValue(ref(db,'transactions'), snapshot=>{
                const txs = snapshot.val()||{};
                let deposits=0, withdrawals=0;
                Object.values(txs).forEach(tx=>{
                    if(tx.type==='deposit') deposits+=parseFloat(tx.amount||0);
                    if(tx.type==='withdrawal') withdrawals+=parseFloat(tx.amount||0);
                });
                totalDepositsEl.innerText = deposits.toFixed(2);
                totalWithdrawalsEl.innerText = withdrawals.toFixed(2);
            });
        }

        function checkAdminAuth() {
            onAuthStateChanged(auth,user=>{
                if(user){
                    const ADMIN_EMAIL = "admin@matrixmarket.com";
                    if(user.email === ADMIN_EMAIL){
                        loadingOverlay.style.display='none';
                        initializeChart();
                        fetchDataAndRenderAnalytics();
                    } else {
                        alert("You do not have administrative privileges.");
                        window.location.href="admin-login.html";
                    }
                } else {
                    alert("You must be logged in as an admin.");
                    window.location.href="admin-login.html";
                }
            });
        }

        async function firebaseLogout(){
            try { await signOut(auth); window.location.href="admin-login.html"; }
            catch(e){ console.error(e); alert("Logout failed"); }
        }

        document.addEventListener('DOMContentLoaded', ()=>{
            document.getElementById('logoutBtn').addEventListener('click',firebaseLogout);
            checkAdminAuth();
        });
    </script>
</body>
</html>
