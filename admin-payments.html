<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MatrixMarket - Admin Payment Control</title>
<style>
  body { font-family:"Poppins",sans-serif; background:linear-gradient(135deg,#0f172a,#1e293b,#4f46e5,#06b6d4); background-size:400% 400%; animation:bgMove 15s ease infinite; color:white; margin:0; padding:0;}
  @keyframes bgMove{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
  header { background: rgba(0,0,0,0.4); padding:15px 30px; display:flex; justify-content:space-between; align-items:center; backdrop-filter:blur(10px);}
  header .logo { font-size:1.6rem; color:#06b6d4; font-weight:bold; }
  nav a { color:white; text-decoration:none; margin-left:15px; font-weight:500; }
  nav a:hover { color:#06b6d4; }
  .container { max-width:1200px; margin:40px auto; background: rgba(255,255,255,0.08); padding:30px; border-radius:20px; box-shadow:0 0 20px rgba(6,182,212,0.5); overflow-x:auto; }
  h1 { text-align:center; text-shadow:0 0 10px #06b6d4; }
  input[type="text"] { width:100%; padding:10px; border:none; border-radius:10px; background: rgba(255,255,255,0.1); color:white; margin-bottom:15px;}
  table { width:100%; border-collapse:collapse; margin-top:10px; min-width:800px; }
  th,td { border:1px solid rgba(255,255,255,0.2); padding:10px; text-align:center; vertical-align:middle; font-size:0.9rem; }
  th { background: rgba(6,182,212,0.3); }
  .btn { padding:6px 12px; border:none; border-radius:8px; cursor:pointer; color:white; margin:2px; font-weight:500; transition:.2s;}
  .approve { background:#06b6d4;} .approve:hover { background:#0891b2; transform:translateY(-1px);}
  .decline { background:#ef4444;} .decline:hover { background:#b91c1c; transform:translateY(-1px);}
  .status-badge { padding:5px 10px; border-radius:8px; font-weight:bold; white-space:nowrap; }
  .status-pending { background: rgba(245,158,11,0.2); color:#f59e0b; }
  .status-approved { background: rgba(34,197,94,0.2); color:#22c55e; }
  .status-declined { background: rgba(239,68,68,0.2); color:#ef4444; }
  .status-proof-submitted { background: rgba(59,130,246,0.2); color:#3b82f6; }
  .status-confirmed-by-seller { background: rgba(139,92,246,0.2); color:#8b5cf6; }
  .section { margin-top:40px; }
  .proof-link { color:#06b6d4; text-decoration:underline; cursor:pointer; }
  footer { text-align:center; padding:15px; background: rgba(255,255,255,0.08); border-top:1px solid rgba(255,255,255,0.1); margin-top:40px; }
</style>
</head>
<body>
<header>
  <div class="logo">MatrixMarket Admin</div>
  <nav>
    <a href="dashboard-admin.html">Dashboard</a>
    <a href="admin-sellers.html">Sellers</a>
    <a href="admin-users.html">Users</a>
    <a href="admin-payments.html" style="font-weight:bold;color:#06b6d4;">Payments</a>
  </nav>
</header>

<div class="container">
  <h1>ðŸ’¸ Manage Seller Payments & Withdrawals</h1>
  <input type="text" id="searchBox" placeholder="Search by email, store, plan, or type..." onkeyup="handleSearch()">

  <!-- Seller Subscription Payments Table -->
  <div class="section">
    <h2>Seller Subscription Requests</h2>
    <table id="subscriptionTable"></table>
  </div>

  <!-- Seller Withdrawal Requests Table -->
  <div class="section">
    <h2>Seller Withdrawals</h2>
    <table id="withdrawalTable"></table>
  </div>
</div>

<footer>Â© 2025 MatrixMarket | Admin Payment Control</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyDFrctk2MZajP7OmECXe5npHAV0dODH9jk",
  authDomain:"matrixmarketplace-1bd71.firebaseapp.com",
  databaseURL:"https://matrixmarketplace-1bd71-default-rtdb.firebaseio.com",
  projectId:"matrixmarketplace-1bd71",
  storageBucket:"matrixmarketplace-1bd71.firebasestorage.app",
  messagingSenderId:"10374416997",
  appId:"1:10374416997:web:9626c569e845c14a87548c",
  measurementId:"G-DTC2GM9L92"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let subscriptionRequests = {};
let withdrawalRequests = {};

onAuthStateChanged(auth,user=>{
  if(!user){ alert("Login required."); window.location.href="admin-login.html"; return; }
  loadSubscriptionRequests();
  loadWithdrawalRequests();
});

function handleSearch(){ renderTables(); }

// ========== Load Data ==========
function loadSubscriptionRequests(){
  onValue(ref(db,'pendingSellerPayments'), snapshot=>{
    subscriptionRequests = snapshot.val() || {};
    renderTables();
  });
}

function loadWithdrawalRequests(){
  onValue(ref(db,'sellerWithdrawals'), snapshot=>{
    withdrawalRequests = snapshot.val() || {};
    renderTables();
  });
}

// ========== Render Tables ==========
function renderTables(){
  const search = document.getElementById('searchBox').value.toLowerCase();

  // Subscription Table
  const subTable = document.getElementById('subscriptionTable');
  subTable.innerHTML=`<tr><th>Email</th><th>Store</th><th>Plan</th><th>Amount</th><th>Status</th><th>Submitted</th><th>Proof</th><th>Action</th></tr>`;
  Object.keys(subscriptionRequests).forEach(id=>{
    const r = subscriptionRequests[id];
    if(r.email?.toLowerCase().includes(search) || r.storeName?.toLowerCase().includes(search) || r.plan?.toLowerCase().includes(search) || r.status?.toLowerCase().includes(search)){
      const proofLink = r.receiptURL ? `<a href="${r.receiptURL}" target="_blank" class="proof-link">View</a>` : 'N/A';
      const statusClass = r.status==="Approved"?"status-approved":r.status==="Declined"?"status-declined":r.status==="Proof Submitted"?"status-proof-submitted":"status-pending";
      subTable.innerHTML+=`<tr>
        <td>${r.email}</td><td>${r.storeName}</td><td>${r.plan}</td>
        <td>${parseFloat(r.amount).toFixed(2)}</td>
        <td><span class="status-badge ${statusClass}">${r.status}</span></td>
        <td>${r.submittedAt||r.requestDate||"N/A"}</td>
        <td>${proofLink}</td>
        <td>
          <button class="btn approve" onclick="updateSubscription('${id}','Approved','${r.userId}')">Approve</button>
          <button class="btn decline" onclick="updateSubscription('${id}','Declined','${r.userId}')">Decline</button>
        </td>
      </tr>`;
    }
  });

  // Withdrawal Table
  const wTable = document.getElementById('withdrawalTable');
  wTable.innerHTML=`<tr><th>Email</th><th>Amount Requested</th><th>Charge</th><th>Net</th><th>Status</th><th>Requested On</th><th>Action</th></tr>`;
  Object.keys(withdrawalRequests).forEach(id=>{
    const r = withdrawalRequests[id];
    if(r.email?.toLowerCase().includes(search) || r.status?.toLowerCase().includes(search)){
      // Calculate charge (2%) and net
      const amount = parseFloat(r.amount);
      const charge = parseFloat((amount * 0.02).toFixed(2));
      const net = parseFloat((amount - charge).toFixed(2));

      const statusClass = r.status==="Approved"?"status-approved":r.status==="Declined"?"status-declined":"status-pending";
      wTable.innerHTML+=`<tr>
        <td>${r.email||'N/A'}</td>
        <td>${amount.toFixed(2)}</td>
        <td>${charge.toFixed(2)}</td>
        <td>${net.toFixed(2)}</td>
        <td><span class="status-badge ${statusClass}">${r.status}</span></td>
        <td>${r.requestedAt?new Date(r.requestedAt).toLocaleString():'N/A'}</td>
        <td>
          <button class="btn approve" onclick="updateWithdrawal('${id}','Approved','${r.userId}',${amount})">Approve</button>
          <button class="btn decline" onclick="updateWithdrawal('${id}','Declined','${r.userId}',${amount})">Decline</button>
        </td>
      </tr>`;
    }
  });
}

// ========== Update Functions ==========
async function updateSubscription(id,status,userId){
  if(!confirm(`Confirm to ${status} subscription request?`)) return;
  await update(ref(db,`pendingSellerPayments/${id}`),{status,statusUpdatedAt:new Date().toISOString()});
  if(status==="Approved") await update(ref(db,`sellers/${userId}`),{status:"Approved",subscription:"Active"});
  else await update(ref(db,`sellers/${userId}`),{status:"Declined",subscription:"Inactive"});
  alert(`Subscription request ${status}!`);
}

async function updateWithdrawal(id,status,userId,amount){
  if(!confirm(`Confirm to ${status} this withdrawal request?`)) return;

  const wRef = ref(db,`sellerWithdrawals/${id}`);
  const userRef = ref(db,`sellers/${userId}`);

  // Calculate charges and net
  const charge = parseFloat((amount * 0.02).toFixed(2));
  const net = parseFloat((amount - charge).toFixed(2));

  if(status==="Approved"){
    const userSnap = await get(userRef);
    const currentBalance = parseFloat(userSnap.val()?.balance || 0);
    if(net > currentBalance){
      return alert(`Cannot approve. Seller balance: ${currentBalance.toFixed(2)} GMD`);
    }
    await update(userRef, { balance: parseFloat((currentBalance - net).toFixed(2)) });
  }

  await update(wRef, { status, charge, net, statusUpdatedAt: new Date().toISOString() });
  alert(`Withdrawal ${status}! Amount: ${amount} GMD, Charge: ${charge} GMD, Net Paid: ${net} GMD`);
}
</script>
</body>
</html>
