<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MatrixMarket - Seller Withdraw</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family:"Poppins",sans-serif; background:linear-gradient(135deg,#0f172a,#1e293b,#4f46e5,#06b6d4); color:white; margin:0; padding:0; }
  header { background: rgba(0,0,0,0.4); padding:15px 30px; display:flex; justify-content:space-between; align-items:center; backdrop-filter:blur(10px);}
  header .logo { font-size:1.6rem; color:#06b6d4; font-weight:bold; }
  .container { max-width:600px; margin:60px auto; background: rgba(255,255,255,0.08); padding:30px; border-radius:20px; box-shadow:0 0 20px rgba(6,182,212,0.5); }
  input, button { width:100%; padding:12px; margin:10px 0; border-radius:10px; border:none; font-size:1rem; }
  input { background: rgba(255,255,255,0.1); color:white; }
  button { background:#06b6d4; color:white; font-weight:bold; cursor:pointer; }
  button:hover { background:#0891b2; }
  .info { margin-top:10px; font-size:0.95rem; }
  .warning { color:#f59e0b; font-weight:bold; }
</style>
</head>
<body>
<header>
  <div class="logo">MatrixMarket Seller</div>
</header>

<div class="container">
  <h1 class="text-center text-2xl mb-4">ðŸ’° Request Withdrawal</h1>
  <p class="info">Minimum withdraw: 100 GMD, Maximum: 3,000,000 GMD. Charges: 2% per 100 GMD withdrawn.</p>

  <input type="number" id="withdrawAmount" placeholder="Enter amount to withdraw">
  <div class="info">
    <p>Charge: <span id="charge">0</span> GMD</p>
    <p>Net you will receive: <span id="net">0</span> GMD</p>
    <p id="warning" class="warning"></p>
  </div>
  <button onclick="submitWithdrawal()">Request Withdraw</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyDFrctk2MZajP7OmECXe5npHAV0dODH9jk",
  authDomain:"matrixmarketplace-1bd71.firebaseapp.com",
  databaseURL:"https://matrixmarketplace-1bd71-default-rtdb.firebaseio.com",
  projectId:"matrixmarketplace-1bd71",
  storageBucket:"matrixmarketplace-1bd71.firebasestorage.app",
  messagingSenderId:"10374416997",
  appId:"1:10374416997:web:9626c569e845c14a87548c",
  measurementId:"G-DTC2GM9L92"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let user = null;
let balance = 0;

// Auth check
onAuthStateChanged(auth, async u => {
  if(!u) { alert("Login required"); window.location.href="login.html"; return; }
  user = u;
  const snap = await get(ref(db, `sellers/${user.uid}`));
  balance = parseFloat(snap.val()?.balance || 0);
});

// Calculate charge & net
const amountInput = document.getElementById("withdrawAmount");
const chargeEl = document.getElementById("charge");
const netEl = document.getElementById("net");
const warningEl = document.getElementById("warning");

amountInput.addEventListener("input", () => {
  const amount = parseFloat(amountInput.value) || 0;
  if(amount < 100 || amount > 3000000){
    warningEl.textContent = "Amount must be between 100 and 3,000,000 GMD";
  } else if(amount > balance){
    warningEl.textContent = `Insufficient balance. Your current balance: ${balance.toFixed(2)} GMD`;
  } else {
    warningEl.textContent = "";
  }

  const charge = parseFloat((amount * 0.02).toFixed(2));
  const net = parseFloat((amount - charge).toFixed(2));
  chargeEl.textContent = charge.toFixed(2);
  netEl.textContent = net.toFixed(2);
});

// Submit withdrawal
async function submitWithdrawal(){
  const amount = parseFloat(amountInput.value);
  if(amount < 100 || amount > 3000000 || amount > balance) return alert("Invalid amount. Please check warnings above.");
  const charge = parseFloat((amount * 0.02).toFixed(2));
  const net = parseFloat((amount - charge).toFixed(2));

  await push(ref(db,'sellerWithdrawals'),{
    userId: user.uid,
    email: user.email,
    amount: amount.toFixed(2),
    charge: charge.toFixed(2),
    net: net.toFixed(2),
    status: "Pending",
    requestedAt: new Date().toISOString()
  });

  alert(`Withdrawal request submitted!\nAmount: ${amount.toFixed(2)} GMD\nCharge: ${charge.toFixed(2)} GMD\nNet: ${net.toFixed(2)} GMD`);
  amountInput.value = "";
  chargeEl.textContent = "0";
  netEl.textContent = "0";
  warningEl.textContent = "";
}
</script>
</body>
</html>
